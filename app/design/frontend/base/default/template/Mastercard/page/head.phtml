<?php
/**
 * Mastercard
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to info@Mastercard.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this module to newer
 * versions in the future. If you wish to customize this module for your
 * needs please refer to http://testserver.Mastercard.com/software/download.cgi
 * for more information.
 *
 * @author Rafael Waldo Delgado Doblas
 * @version $Id$
 * @copyright Mastercard, 1 Jul, 2016
 * @license http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 * @package Mastercard
 **/
?>
<?php
/** @var Mage_Core_Block_Abstract $this */
$storeName = Mage::getStoreConfig('general/store_information/name');
if (!$storeName) {
    $storeName = 'Magento Store';
}
?>

<script
	src="<?php echo Mage::getSingleton('mpgs/config_hosted')->getJsApiUrl(); ?>"
	data-error="errorCallback" data-cancel="cancelCallback"
	data-complete=completeCallback>
</script>

<script type='text/javascript'>

	_Checkout = Checkout;

	function errorCallback(error) {
		alert(error.cause + ' - ' + error.explanation);
	}

	function cancelCallback() {
		alert('Payment cancelled');
	}

	function completeCallback(code) {
		console.log('Payment completed');
		var input = document.createElement("input");
		input.setAttribute("type", "hidden");
		input.setAttribute("id", "res_code");
		input.setAttribute("name", "res_code");
		input.setAttribute("value", code);
		document.getElementById("co-payment-form").appendChild(input);
		review.save();
	}

	function configureMpgs(username, sessionId) {
		_Checkout.configure({
			merchant: username,
			session: {
				id: sessionId
			},
            interaction: {
                merchant: {
                    name: "<?php echo $this->jsQuoteEscape($storeName, '"'); ?>"
                }
            }
		});
		_Checkout.showLightbox();
	}

	function showMpgsLightbox(cartid) {
	    new Ajax.Request('<?php echo Mage::getUrl('api/rest/createsession', array('_secure'=>true)); ?>', {
	        contentType: 'application/json',
            requestHeaders: {
                Accept: 'application/json'
            },
            parameters: JSON.stringify({
                cartid: cartid
            }),
            onSuccess: function (response) {
	            var data = response.responseJSON;
                configureMpgs(data.merchant, data.SessionID);
            },
            onFailure: function (response) {
                var data = response.responseJSON;
                alert(data.messages.error[0].message);
            }
        });
	}
</script>
