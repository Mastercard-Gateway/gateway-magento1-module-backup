<?php
/**
 * Mastercard
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to info@Mastercard.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this module to newer
 * versions in the future. If you wish to customize this module for your
 * needs please refer to http://testserver.Mastercard.com/software/download.cgi
 * for more information.
 *
 * @author Rafael Waldo Delgado Doblas
 * @version $Id$
 * @copyright Mastercard, 1 Jul, 2016
 * @license http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 * @package Mastercard
 **/

/**
 * This template add some javascript methods needed by MPGS payment to the checkout header
 */
?>

<meta http-equiv="Content-Type"
	content="<?php echo $this->getContentType() ?>" />
<title><?php echo $this->getTitle() ?></title>
<meta name="description"
	content="<?php echo htmlspecialchars($this->getDescription()) ?>" />
<meta name="keywords"
	content="<?php echo htmlspecialchars($this->getKeywords()) ?>" />
<meta name="robots"
	content="<?php echo htmlspecialchars($this->getRobots()) ?>" />
<link rel="icon" href="<?php echo $this->getFaviconFile(); ?>"
	type="image/x-icon" />
<link rel="shortcut icon" href="<?php echo $this->getFaviconFile(); ?>"
	type="image/x-icon" />
<!--[if lt IE 7]>
<script type="text/javascript">
//<![CDATA[
    var BLANK_URL = '<?php echo $this->helper('core/js')->getJsUrl('blank.html') ?>';
    var BLANK_IMG = '<?php echo $this->helper('core/js')->getJsUrl('spacer.gif') ?>';
//]]>
</script>
<![endif]-->
<?php echo $this->getCssJsHtml()?>
<?php echo $this->getChildHtml()?>
<?php echo $this->helper('core/js')->getTranslatorScript()?>
<?php echo $this->getIncludes()?>

<script
	src="<?php echo Mage::getSingleton('mpgs/config')->getJsApiUrl(); ?>"
	data-error="errorCallback" data-cancel="cancelCallback"
	data-complete=completeCallback>
</script>

<script type='text/javascript'>

	_Checkout = Checkout;

	function errorCallback(error) {
		alert(error.cause + ' - ' + error.explanation);
	}

	function cancelCallback() {
		alert('Payment cancelled');
	}

	function completeCallback(code) {
		console.log('Payment completed');
		var input = document.createElement("input");
		input.setAttribute("type", "hidden");
		input.setAttribute("id", "res_code");
		input.setAttribute("name", "res_code");
		input.setAttribute("value", code);
		document.getElementById("co-payment-form").appendChild(input);
		review.save();
	}

	function configureMpgs(username, sessionId) {
		_Checkout.configure({
			merchant: username,
			session: {
				id: sessionId,
			}
		});
		_Checkout.showLightbox();
	}

	var $j = jQuery.noConflict();
	function showMpgsLightbox(cartid) {
		$j.ajax({
			type: "POST",
			url: '<?php echo Mage::getUrl('api/rest/createsession', array('_secure'=>true)); ?>',
			dataType: 'json',
			contentType: 'application/json',
			async: false,
			data: '{"cartid": "' + cartid + '"}',
			success: function (data) {
				configureMpgs(data.merchant, data.SessionID);
			},
			error: function (error) {
				alert(error.responseJSON.messages.error[0].message);
			},
		});
	}

</script>
